sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/SearchField","sap/m/MessageToast","sap/ui/table/Column","sap/m/Label","sap/m/Text","sap/m/ColumnListItem","sap/ui/export/library"],function(e,t,a,n,r,i,l,o,s,p,d,u){"use strict";const{BusyIndicator:m}=a;const c=u.EdmType;return e.extend("com.zeffortcalculator.controller.Search",{onInit:function(){this.getView().addEventDelegate({onAfterRendering:()=>{this.tbCustomerTemplate=this.getView().byId("tbCustomer")?.getBindingInfo("items")?.template;this.getView().byId("hclImg").attachPress(()=>{this.onHome()})}});this.getRouter().getRoute("Search").attachPatternMatched(this.onSearchMatched,this)},onUpdateFinished:function(e){if(!e.getParameter("actual"))l.show("No results returned by the search criteria")},onSearchMatched:function(e){if(e.getParameter("arguments").OpportunityId){this.getOwnerModel("oModelEstCal").setProperty("/searchParam",e.getParameter("arguments").OpportunityId);this.onSearch()}else{this.getOwnerModel("oModelEstCal").setProperty("/searchParam","");let e=this.getView().byId("tbCustomer");e.setVisible(false);e.unbindItems()}},onSearch:function(){let e=[];let t=this.getView().byId("tbCustomer");if(this.getOwnerModel("oModelEstCal").getProperty("/searchParam")){let a=this.getOwnerModel("oModelEstCal").getProperty("/searchParam");e.push(new n({path:"CustId",operator:a.includes("*")?r.Contains:r.EQ,value1:a}));e.push(new n({path:"OpportunityId",operator:a.includes("*")?r.Contains:r.EQ,value1:a.toUpperCase()}));t.bindItems({path:"/zi_hcl_free_sel",template:this?.tbCustomerTemplate,filters:e});t.setVisible(true)}else{t.setVisible(false);t.unbindItems()}},onItemPress:function(e){if(e.getSource().getBindingContext()){this.getRouter().navTo("Detail",{CustId:e.getSource().getBindingContext().getProperty("CustId"),OpportunityId:e.getSource().getBindingContext().getProperty("OpportunityId"),Version:e.getSource().getBindingContext().getProperty("Version")},false)}},handleValueHelp:function(){m.show();let e=this.callBackEnd("/zi_hcl_value_help","GET",[],{},{});e.then(e=>{let a=e.data.results;this.getOwnerModel("oModelEstCal").setProperty("/custValueHelp",a);m.hide();this._oBasicSearchField=new i;this.loadFragment({name:"com.zeffortcalculator.view.fragment.ValueHelpDialog"}).then(function(e){var a=e.getFilterBar(),n,r,i,l,u;this._oVHD=e;this.getView().addDependent(e);a.setFilterBarExpanded(false);a.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(function(){a.search()});e.getTableAsync().then(function(a){a.setModel(this.getOwnerModel("oModelEstCal"));if(a.bindRows){a.bindAggregation("rows",{path:"/custValueHelp",events:{dataReceived:function(){e.update()}}});n=new o({label:new s({text:"Opportunity ID"}),template:new p({wrapping:false,text:"{OpportunityId}"})});n.data({fieldName:"OpportunityId"});r=new o({label:new s({text:"Customer ID"}),template:new p({wrapping:false,text:"{CustId}"})});r.data({fieldName:"CustId"});i=new o({label:new s({text:"Customer Name"}),template:new p({wrapping:false,text:"{CustName}"})});i.data({fieldName:"CustName"});u=new o({label:new s({text:"Created By"}),template:new p({wrapping:false,text:"{Email}"})});u.data({fieldName:"Email"});l=new o({label:new s({text:"Created On"}),template:new p({wrapping:false,text:{path:"LastChangedOn",type:"sap.ui.model.type.Date",formatOptions:{pattern:"MMM dd,yyyy"}}})});l.data({fieldName:"LastChangedOn"});a.addColumn(n);a.addColumn(r);a.addColumn(i);a.addColumn(u);a.addColumn(l)}if(a.bindItems){let e=new t;e.setData({cols:[{label:"Opportunity ID",template:"OpportunityId"},{label:"Customer ID",template:"CustId"},{label:"Customer Name",template:"CustName",demandPopin:true},{label:"Created By",template:"Email",demandPopin:true},{label:"Created On",template:"LastChangedOn",demandPopin:true}]});a.setModel(e,"columns");a.bindAggregation("items","/custValueHelp",function(e,t){let n=a.getModel("columns").getData().cols;return new d({cells:n.map(function(e){let t=e.template;if(t=="LastChangedOn"){return new s({text:{path:"LastChangedOn",type:"sap.ui.model.type.Date",formatOptions:{pattern:"MMM dd,yyyy"}}})}return new s({text:"{"+t+"}"})})})})}e.update()}.bind(this));e.open()}.bind(this))}).catch(e=>{m.hide();console.log(e)})},onFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var i=a.reduce(function(e,t){if(t.getValue()){e.push(new n({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[]);i.push(new n({filters:[new n({path:"OpportunityId",operator:r.Contains,value1:t}),new n({path:"CustId",operator:r.Contains,value1:t})],and:false}));this._filterTable(new n({filters:i,and:true}))},_filterTable:function(e){var t=this._oVHD;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onValueHelpOkPress:function(e){var t=e.getParameter("tokens")[0].mProperties.text;this.getOwnerModel("oModelEstCal").setProperty("/searchParam",t);this._oVHD.close()},onValueHelpCancelPress:function(){this._oVHD.close()},onValueHelpAfterClose:function(){this._oVHD.destroy()},onSearchResultExport:function(){let e="Search Results";let t=this.getView().byId("tbCustomer");let a=t.getBinding("items");let n=[{label:"Customer ID",property:"CustId",type:c.String},{label:"Opportunity ID",type:c.String,property:"OpportunityId",scale:0},{label:"Version",property:"Version",type:c.String},{label:"Price",property:["SrvcCst","Currency"],type:c.String,template:"{0}, {1}"},{label:"Created By",property:"Email",type:c.String},{label:"Created on",property:"LastChangedOn",type:c.Date},{label:"Comment",property:"Comments",type:c.String}];this.onCommonExport(a,n,e)}})});
//# sourceMappingURL=Search.controller.js.map